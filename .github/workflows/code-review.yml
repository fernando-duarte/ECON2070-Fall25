name: code-review
on: [push, pull_request]
jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Determine range
        id: range
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin "${{ github.base_ref }}" --depth=200
            echo "range=origin/${{ github.base_ref }}..HEAD" >> $GITHUB_OUTPUT
          else
            echo "range=${{ github.event.before }}..${{ github.sha }}" >> $GITHUB_OUTPUT
          fi
      - name: Block commit messages
        run: |
          git log --format=%B ${{ steps.range.outputs.range }} | \
          grep -Eiq '(co-?authored-?by:.*ai|generated|automated|assistant)' && \
            { echo "Forbidden text in commit messages"; exit 1; } || true
      - name: Block added lines
        run: |
          git diff -U0 ${{ steps.range.outputs.range }} | \
          grep -Eiq '^\+.*(co-?authored-?by:.*ai|generated|automated|assistant)' && \
            { echo "Forbidden text in added lines"; exit 1; } || true